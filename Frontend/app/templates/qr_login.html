{% extends 'template.html' %}
{% block content %}
<div class="login-container">
    <h2>Login with QR Code</h2>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display: none;"></canvas>
    <p id="message">Point the camera at the QR code to scan.</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js">

</script>
<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const message = document.getElementById('message');

    const canvasContext = canvas.getContext('2d');

    async function startCamera() {
        try {
            video.srcObject = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}});
        } catch (error) {
            message.textContent = 'Error accessing camera: ' + error.message;
        }
    }

    function scanQRCode() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
            const qrCodeData = jsQR(imageData.data, imageData.width, imageData.height);

            if (qrCodeData) {
                message.textContent = 'QR Code detected! Sending data to server...';

                fetch('/api/auth/qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({qrCode: qrCodeData.data}),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            message.textContent = 'Login successful!';
                        } else {
                            message.textContent = 'Authentication failed: ' + data.message;
                        }
                    })
                    .catch(error => {
                        message.textContent = 'Error: ' + error.message;
                    });
            } else {
                message.textContent = 'Scanning...';
            }
        }

        requestAnimationFrame(scanQRCode);
    }

    window.addEventListener('load', () => {
        startCamera().then(() => {
            requestAnimationFrame(scanQRCode);
        });
    });
</script>

{% endblock %}
